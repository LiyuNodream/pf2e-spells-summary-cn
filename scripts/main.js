(()=>{"use strict";var e={d:(t,s)=>{for(var n in s)e.o(s,n)&&!e.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:s[n]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};e.d({},{c:()=>r});let t="";function s(...e){return`${t}.settings.${e.join(".")}`}function n(e){const t=[];return e.spellcastingEntries.forEach((e=>{if(!e.isRitual||!e.hasCollection||!e.levels.some((e=>e.active.some((e=>null!==e)))))return;const s=e.id,n=e.name;e.levels.forEach((e=>{if(!e.active.length)return;const a=e.active.filter((e=>e));t.push(...a.flatMap(((t,a)=>({id:t.spell.id,name:t.spell.name,img:t.spell.img,level:e.level,slotId:a,entryId:s,entryName:n,time:t.spell.system.time.value,secondary:t.spell.system.secondarycasters.value}))))}))})),t.sort(((e,t)=>e.level-t.level)),t}function a(e){const s=e.data.resources.focus,n=[];e.spellcastingEntries.forEach((e=>{if(e.isRitual||!e.hasCollection||!e.levels.some((e=>e.active.some((e=>null!==e)))))return;const t=e.statistic.check,a=e.statistic.dc,l=!!e.isPrepared,o=!!e.isFlexible,i=!!e.isFocusPool,r=!!e.isSpontaneous,c=!!e.isInnate,u=e.name,d=e.id,f="charge"===e.system.prepared.value,p=void 0!==getProperty(e,"flags.pf2e-staves.staveID"),m={value:getProperty(e,"flags.pf2e-staves.charges")??0,max:0};e.levels.forEach((e=>{if(!e.active.length)return;const g=e.active.filter((e=>e));n[e.level]??={level:e.level,isCantrip:e.isCantrip,spells:[]},n[e.level].spells.push(...g.flatMap(((n,g)=>({id:n.spell.id,name:n.spell.name,img:n.spell.img,uses:n.uses,isVirtual:!!n.virtual,icon:n.spell.system.time.value,entryId:d,entryName:u,slotId:g,isPrepared:l,isFlexible:o,isInnate:c,isSpontaneous:r,isFocus:i,isCharge:f,isStaff:p,dc:a,check:t,parentUses:f?m:e.uses,expended:!e.isCantrip&&(f?m.value<e.level:l&&!o?!!n.expended:i?s.value<=0:c&&null!=n.uses?.value?n.uses.value<=0:!(!r&&!o||null==e.uses?.value)&&e.uses.value<=0),order:f?0:l?1:i?2:c?3:r?4:5}))))}))}));const a=("order",game.settings.get(t,"order")?(e,t)=>e.order===t.order?e.name.localeCompare(t.name):e.order-t.order:(e,t)=>e.name.localeCompare(t.name));return n.forEach((e=>e.spells.sort(a))),n}function l(e){e.preventDefault(),e.currentTarget.closest(".item")?.classList.add("hover")}function o(e){e.preventDefault(),e.currentTarget.closest(".item")?.classList.remove("hover")}function i(e){return e.find("section.sheet-body .sheet-content > .tab[data-tab=spellcasting]")}const r="pf2e-spells-summary";function c(){Object.values(ui.windows).forEach((e=>e instanceof ActorSheet&&"character"===e.actor.type&&e.render()))}t||(t=r),Hooks.on("renderCharacterSheetPF2e",(async function(e,s,c){const u=e.actor;if(u.pack||!u.id||!game.actors.has(u.id))return;const d=i(s);getProperty(e,`modules.${r}.toggled`)&&d.addClass("toggled"),function(e,t){(function(e){return e.find("nav.sheet-navigation .item[data-tab=spellcasting]")})(e).on("click",(s=>function(e,t,s){e.preventDefault();const n=i(t);n.hasClass("active")&&(n.toggleClass("toggled"),n.scrollTop(0),setProperty(s,`modules.${r}.toggled`,n.hasClass("toggled")))}(s,e,t)))}(s,e),await async function(e,s,r){const c=i(e),u=await renderTemplate(function(...e){return e=e.filter((e=>"string"==typeof e)),`modules/${t}/templates/${e.join("/")}`}("sheet.hbs"),{entries:a(s),rituals:n(s),focusPool:s.data.resources.focus,editable:s.editable});c.append(u),function(e,t){const s=function(e){return i(e).find(".directory-list.summary")}(e),n=s.find(".spell-range .uses .spell-slots-input input");n.on("change",(e=>function(e,t){e.preventDefault();const{itemId:s,itemProperty:n}=e.currentTarget.dataset;if(!s||!n)return;const a=Math.max(e.currentTarget.valueAsNumber,0);t.actor.updateEmbeddedDocuments("Item",[{_id:s,[n]:a}])}(e,t))),n.on("focus",l),n.on("blur",o),s.find(".cast-spell").on("click",(e=>function(e,t){e.preventDefault();const{itemId:s,slotLevel:n,slotId:a,entryId:l}=$(e.currentTarget).closest(".item").data(),o=t.actor.spellcasting.collections.get(l,{strict:!0});if(!o)return;const i=o.get(s,{strict:!0});i&&o.entry.cast(i,{slot:a,level:n})}(e,t))),s.find(".item-toggle-prepare").on("click",(e=>function(e,t){e.preventDefault();const{slotLevel:s,slotId:n,entryId:a,expendedState:l}=$(e.currentTarget).closest(".item").data(),o=t.actor.spellcasting.collections.get(a);o?.setSlotExpendedState(s??0,n??0,!0!==l)}(e,t))),s.find(".focus-pips").on("click contextmenu",(e=>function(e,t){e.preventDefault();const s="click"===e.type?1:-1,n=(t.actor.system.resources.focus?.value??0)+s;t.actor.update({"system.resources.focus.value":n})}(e,t))),s.find(".spell-slots-increment-reset").on("click",(e=>function(e,t){e.preventDefault();const{itemId:s,level:n,staff:a}=$(e.currentTarget).data();if(!s)return;if(a)return void function(e,t){const s=function(e){return i(e).find(".directory-list.spellcastingEntry-list")}(e.element),n=s.find(`.item-container.spellcasting-entry[data-item-id=${t}]`).find(".spell-ability-data .statistic-values a.pf2e-staves-charge");n[0]?.click()}(t,s);const l=t.actor.items.get(s);var o;if(l)if(l.isOfType("spellcastingEntry")){const{system:e}=l.toObject();if(!e.slots)return;const t=(o=n)>=0&&o<=11?`slot${n}`:"slot0";e.slots[t].value=e.slots[t].max,l.update({system:e})}else if(l.isOfType("spell")){const e=l.system.location.uses?.max;if(!e)return;l.update({"system.location.uses.value":e})}}(e,t))),s.find(".item-image").on("click",(e=>async function(e,t){const s=$(e.currentTarget).closest(".item").attr("data-item-id"),n=t.actor.items.get(s??"",{strict:!0});!n||n.isOfType("physical")&&!n.isIdentified||await n.toMessage(e)}(e,t))),s.find(".item-name > h4").on("click",(e=>async function(e,t){const s=e.currentTarget.closest(".item");await t.itemRenderer.toggleSummary(s)}(e,t)))}(e,r)}(s,c,e),d.hasClass("toggled")&&d.hasClass("active")&&e._restoreScrollPositions(s)})),Hooks.once("ready",(()=>{!function(e){const n=e.name;e.scope=e.scope??"world",e.config=e.config??!1,e.config&&(e.name=s(n,"name"),e.hint=s(n,"hint")),Array.isArray(e.choices)&&(e.choices=e.choices.reduce(((e,t)=>(e[t]=s(n,"choices",t),e)),{})),game.settings.register(t,n,e)}({name:"order",type:Boolean,default:!1,config:!0,scope:"client",onChange:c})}))})();
//# sourceMappingURL=main.js.map