(()=>{"use strict";var e={d:(t,s)=>{for(var n in s)e.o(s,n)&&!e.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:s[n]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};e.d({},{c:()=>c});let t="";function s(...e){return`${t}.settings.${e.join(".")}`}function n(e){const t=[];return e.spellcastingEntries.forEach((e=>{if(!e.isRitual||!e.hasCollection||!e.levels.some((e=>e.active.some((e=>null!==e)))))return;const s=e.id,n=e.name;e.levels.forEach((e=>{if(!e.active.length)return;const a=e.active.filter((e=>e));t.push(...a.flatMap(((t,a)=>({id:t.spell.id,name:t.spell.name,img:t.spell.img,level:e.level,slotId:a,entryId:s,entryName:n,time:t.spell.system.time.value,secondary:t.spell.system.secondarycasters.value}))))}))})),t.sort(((e,t)=>e.level-t.level)),t}const a=/\((amp|psi|psy|psychic|amped)\)/i;function l(e){const s=e.data.resources.focus,n=[];e.spellcastingEntries.forEach((e=>{if(e.isRitual||!e.hasCollection||!e.levels.some((e=>e.active.some((e=>null!==e)))))return;const t=e.statistic.check,l=e.statistic.dc,i=!!e.isPrepared,o=!!e.isFlexible,r=!!e.isFocusPool,c=!!e.isSpontaneous,u=!!e.isInnate,d=e.name,p=e.id,f="charge"===e.system.prepared.value,m=void 0!==getProperty(e,"flags.pf2e-staves.staveID"),g={value:getProperty(e,"flags.pf2e-staves.charges")??0,max:0};e.levels.forEach((e=>{if(!e.active.length)return;const v=e.isCantrip,y=e.active.filter((e=>e));n[e.level]??={level:e.level,isCantrip:v,spells:[]},n[e.level].spells.push(...y.flatMap(((n,y)=>({id:n.spell.id,name:n.spell.name,img:n.spell.img,uses:n.uses,isVirtual:!!n.virtual,icon:n.spell.system.time.value,entryId:p,entryName:d,slotId:y,range:n.spell.system.range.value,isPrepared:i,isFlexible:o,isInnate:u,isSpontaneous:c,isFocus:r,isCharge:f,isStaff:m,isAmpedCantrip:!(!v||!r)&&a.test(n.spell.name),dc:l,check:t,parentUses:f?g:e.uses,expended:!e.isCantrip&&(f?g.value<e.level:i&&!o?!!n.expended:r?s.value<=0:u&&null!=n.uses?.value?n.uses.value<=0:!(!c&&!o||null==e.uses?.value)&&e.uses.value<=0),order:f?0:i?1:r?2:u?3:c?4:5}))))}))}));const l=("order",game.settings.get(t,"order")?(e,t)=>e.order===t.order?e.name.localeCompare(t.name):e.order-t.order:(e,t)=>e.name.localeCompare(t.name));return n.forEach((e=>e.spells.sort(l))),n}function i(e){e.preventDefault(),e.currentTarget.closest(".item")?.classList.add("hover")}function o(e){e.preventDefault(),e.currentTarget.closest(".item")?.classList.remove("hover")}function r(e){return e.find("section.sheet-body .sheet-content > .tab[data-tab=spellcasting]")}const c="pf2e-spells-summary";function u(){Object.values(ui.windows).forEach((e=>e instanceof ActorSheet&&"character"===e.actor.type&&e.render()))}t||(t=c),Hooks.on("renderCharacterSheetPF2e",(async function(e,s,a){const u=e.actor;if(u.pack||!u.id||!game.actors.has(u.id))return;const d=r(s);getProperty(e,`modules.${c}.toggled`)&&d.addClass("toggled"),function(e,t){(function(e){return e.find("nav.sheet-navigation .item[data-tab=spellcasting]")})(e).on("click",(s=>function(e,t,s){e.preventDefault();const n=r(t);n.hasClass("active")&&(n.toggleClass("toggled"),n.scrollTop(0),setProperty(s,`modules.${c}.toggled`,n.hasClass("toggled")))}(s,e,t)))}(s,e),await async function(e,s,a){const c=r(e),u=await renderTemplate(function(...e){return e=e.filter((e=>"string"==typeof e)),`modules/${t}/templates/${e.join("/")}`}("sheet.hbs"),{entries:l(s),rituals:n(s),focusPool:s.data.resources.focus,editable:s.editable});c.append(u),function(e,t){const s=function(e){return r(e).find(".directory-list.summary")}(e),n=s.find(".spell-range .uses .spell-slots-input input");n.on("change",(e=>function(e,t){e.preventDefault();const{itemId:s,itemProperty:n}=e.currentTarget.dataset;if(!s||!n)return;const a=Math.max(e.currentTarget.valueAsNumber,0);t.actor.updateEmbeddedDocuments("Item",[{_id:s,[n]:a}])}(e,t))),n.on("focus",i),n.on("blur",o),s.find(".cast-spell").on("click",(e=>function(e,t){e.preventDefault();const{itemId:s,slotLevel:n,slotId:a,entryId:l}=$(e.currentTarget).closest(".item").data(),i=t.actor.spellcasting.collections.get(l,{strict:!0});if(!i)return;const o=i.get(s,{strict:!0});o&&i.entry.cast(o,{slot:a,level:n})}(e,t))),s.find(".item-toggle-prepare").on("click",(e=>function(e,t){e.preventDefault();const{slotLevel:s,slotId:n,entryId:a,expendedState:l}=$(e.currentTarget).closest(".item").data(),i=t.actor.spellcasting.collections.get(a);i?.setSlotExpendedState(s??0,n??0,!0!==l)}(e,t))),s.find(".focus-pips").on("click contextmenu",(e=>function(e,t){e.preventDefault();const s="click"===e.type?1:-1,n=(t.actor.system.resources.focus?.value??0)+s;t.actor.update({"system.resources.focus.value":n})}(e,t))),s.find(".spell-slots-increment-reset").on("click",(e=>function(e,t){e.preventDefault();const{itemId:s,level:n,staff:a}=$(e.currentTarget).data();if(!s)return;if(a)return void function(e,t){const s=function(e){return r(e).find(".directory-list.spellcastingEntry-list")}(e.element),n=s.find(`.item-container.spellcasting-entry[data-item-id=${t}]`).find(".spell-ability-data .statistic-values a.pf2e-staves-charge");n[0]?.click()}(t,s);const l=t.actor.items.get(s);var i;if(l)if(l.isOfType("spellcastingEntry")){const{system:e}=l.toObject();if(!e.slots)return;const t=(i=n)>=0&&i<=11?`slot${n}`:"slot0";e.slots[t].value=e.slots[t].max,l.update({system:e})}else if(l.isOfType("spell")){const e=l.system.location.uses?.max;if(!e)return;l.update({"system.location.uses.value":e})}}(e,t))),s.find(".item-image").on("click",(e=>async function(e,t){const s=$(e.currentTarget).closest(".item").attr("data-item-id"),n=t.actor.items.get(s??"",{strict:!0});!n||n.isOfType("physical")&&!n.isIdentified||await n.toMessage(e)}(e,t))),s.find(".item-name > h4").on("click",(e=>async function(e,t){const s=e.currentTarget.closest(".item");await t.itemRenderer.toggleSummary(s)}(e,t)))}(e,a)}(s,a,e),d.hasClass("toggled")&&d.hasClass("active")&&e._restoreScrollPositions(s)})),Hooks.once("ready",(()=>{!function(e){const n=e.name;e.scope=e.scope??"world",e.config=e.config??!1,e.config&&(e.name=s(n,"name"),e.hint=s(n,"hint")),Array.isArray(e.choices)&&(e.choices=e.choices.reduce(((e,t)=>(e[t]=s(n,"choices",t),e)),{})),game.settings.register(t,n,e)}({name:"order",type:Boolean,default:!1,config:!0,scope:"client",onChange:u})}))})();
//# sourceMappingURL=main.js.map